{% extends 'base.html.twig' %}

{% block stylesheets %}
    <style>
        .horses-title {
            font-size: 16px;
            padding: 5px 5px 5px 0;
        }

        .courses-history-title {
            padding-top: 10px;
        }

        .progress-add-course-card, .progress-update-history, .progress-update-horse {
            display: none;
        }

        #update_course_card_history_countType {
            position:absolute;
              display: inline;
              height: 0;
              padding: 0;
              width: 0;
              border: none;
              box-shadow: unset;
          }
    </style>
    <link rel="stylesheet" href="{{ asset('build/css/table.css') }}">
{% endblock %}

{% block body %}
    {{ include('common/nav.html.twig') }}

    <div class="row">
        <h3 class="col xl12 center-align">{{user.completeName}}</h3>
        <div class="col xl4 offset-xl2">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Coordonnées</span>
                    <p>
                        {{user.completeName}}<br>

                        {% if user.address == null %}
                            <i>Adresse non définie</i><br>
                        {% else %}
                            {{ user.address }}<br>
                            {{ user.zipCode }} {{user.country }}<br>
                        {% endif %}

                        {% if user.username == null %}
                            {{ user.username }}
                        {% else %}
                            {{user.username}} / {{ user.phone }}
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <span class="card-title">Carte de cours</span>

                    {{ include('dashboard/admin/sections/courseCard.html.twig') }}

                </div>
                <div class="card-reveal">
                    <span class="card-title grey-text text-darken-4">Ajouter un décompte<i class="material-icons right">close</i></span>

                    <div class="col xl12 l12 m12 s12" id="flashMessagesCourseCardHistory"></div>

                    {{ include('dashboard/admin/ajax/forms/updateCourseCard.html.twig') }}

                </div>
            </div>
        </div>

        <div class="col xl4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        {% transchoice user.horse|length %}
                            [0,1] Cheval|]1,Inf[ Chevaux
                        {% endtranschoice %}
                    </span>

                    {{ include('dashboard/admin/sections/horse.html.twig') }}

                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col xl8 l8 m12 s12 offset-xl2 offset-l2">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Factures</span> <a class="modal-trigger btn-floating btn-large waves-effect waves-light absolute-icon" href="#addBill"><i class="material-icons">add</i></a>

                    <div id="addBill" class="modal">
                        <div class="modal-content">
                            <h4>Ajout d'une facture</h4>
                        </div>
                    </div>

                    <div class="table-responsive-vertical" id="usersTR">
                        <table id="table" class="table table-hover table-mc-light-green">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type de facture</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td data-title="Date">01/01/1970</td>
                                    <td data-title="Type de facture">Ajout</td>
                                    <td data-title="Montant">200 €</td>
                                    <td data-title="Statut">en attente</td>
                                    <td data-title="Action">edit</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        // Initialisation des modals
        function initMaterialize() {
            $('.modal').modal();
            $('select').material_select();
        }

        // Chargement du formulaire d'ajout d'une carte de cours
        function loadModalAddCourseCard() {
            $('body').on('click', '.add-course-card-modal-trigger', function (e) {
                var url = $('#addCourseCard').attr('data-url');
                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function (data) {
                        $('#modalContentAddCourseCard').replaceWith(data);
                    }
                })
            });
        }

        // Rechargement des contacts utiles
        function loadModalUpdateHorse() {
            $('body').on('click', '.edit-horse-modal-trigger', function (e) {
                var htmlID = '#edit-horse-modal-';
                var dataID = e.currentTarget.dataset.id;
                console.log(htmlID);
                console.log(dataID);
                var url = $(htmlID+dataID).attr('data-url');
                console.log(url);
                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function (data) {
                        $('#modalContentUpdateHorse'+dataID).replaceWith(data);
                        Materialize.updateTextFields();
                        $('select').material_select();
                    }
                })
            });
        }

        // Rechargement des informations lié à la carte de cours
        function reloadCourseCardSection() {
            var url = $('#courseCardInformations').attr('data-url');
            $.ajax({
                type: 'GET',
                url: url,
                success: function (data) {
                    $('#courseCardInformations').replaceWith(data);
                    initMaterialize();
                }
            })
        }

        // Soumission du formulaire d'ajout d'une carte de cours
        function addCourseCard() {
            $('body').on('submit', 'form[name="add_course_card"]', function (e) {
                e.preventDefault();
                $('.progress-add-course-card').show();
                var $form = $(this);
                var url = $('#add_course_card_submit').attr('data-url');
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: $form.serialize(),
                    success: function (data) {
                        var success = '<div class="card-panel green accent-4" id="confirmationAddCourseCard">' + data + '</div>';

                        $('#flashMessagesAddCourseCard').html(success);

                        $('.progress-add-course-card').hide();

                        function removeFlashMsg() {
                            $('#confirmationAddCourseCard').replaceWith('');
                            $('#addCourseCard').modal('close');
                            reloadCourseCardSection();
                        }
                        setTimeout(removeFlashMsg, 600);

                    },
                    error: function (jqxhr) {
                        var error = '<div class="card-panel deep-orange accent-4">' + jqxhr.responseText + '</div>';
                        $('#flashMessagesAddCourseCard').html(error);
                        $('.progress-add-course-card').hide();
                    }
                })
            });
        }

        // Soumission du formulaire de mise à jour de la carte de son historique
        function addCourseCardHistory() {
            $('body').on('submit', 'form[name="update_course_card_history"]', function (e) {
                e.preventDefault();
                $('.progress-update-history').show();
                var $form = $(this);
                var url = $('#update_course_card_history_submit').attr('data-url');
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: $form.serialize(),
                    success: function (data) {
                        var success = '<div class="card-panel green accent-4" id="confirmationUpdateCourseCardHistory">' + data + '</div>';

                        $('#flashMessagesCourseCardHistory').html(success);

                        $('.progress-update-history').hide();

                        function removeFlashMsg() {
                            $('#confirmationUpdateCourseCardHistory').replaceWith('');
                        }
                        setTimeout(removeFlashMsg, 5000);
                        reloadCourseCardSection();
                        reloadUpdateCourseCardForm();
                    },
                    error: function (jqxhr) {
                        var error = '<div class="card-panel deep-orange accent-4">' + jqxhr.responseText + '</div>';
                        $('#flashMessagesCourseCardHistory').html(error);
                        $('.progress-update-history').hide();
                    }
                })
            });
        }

        // Soumission du formulaire de mise à jour d'un cheval
        function updateHorse() {
            $('body').on('submit', 'form[name="update_horse"]', function (e) {
                e.preventDefault();
                $('.progress-update-horse').show();
                var $form = $(this);
                var url = $('#update_horse_submit').attr('data-url');
                var id = $('#update_horse_submit').attr('data-id');

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: $form.serialize(),
                    success: function (data) {
                        var success = '<div class="card-panel green accent-4" id="confirmationUpdateHorse'+id+'">' + data + '</div>';

                        $('#flashMessagesUpdateHorse'+id).html(success);

                        $('.progress-update-horse').hide();

                        function removeFlashMsg() {
                            $('#confirmationUpdateHorse'+id).replaceWith('');
                            $('#horse'+id).modal('close');
                            reloadHorseSection();
                        }
                        setTimeout(removeFlashMsg, 600);

                    },
                    error: function (jqxhr) {
                        var error = '<div class="card-panel deep-orange accent-4">' + jqxhr.responseText + '</div>';
                        $('#flashMessagesUpdateHorse'+id).html(error);
                        $('.progress-update-horse').hide();
                    }
                })
            });
        }

        // Rechargement des informations lié à la carte de cours
        function reloadHorseSection() {
            var url = $('#horsesInformations').attr('data-url');
            $.ajax({
                type: 'GET',
                url: url,
                success: function (data) {
                    $('#horsesInformations').replaceWith(data);
                    initMaterialize();
                }
            })
        }

        // Rechargement du formulaire de ajout d'un cavalier
        function reloadUpdateCourseCardForm() {
            var url = $('#updateCourseCardForm').attr('data-url');
            $.ajax({
                type: 'GET',
                url: url,
                success: function (data) {
                    $('#updateCourseCardForm').replaceWith(data);

                    initMaterialize();
                }
            })
        }

        // Fonction de pagination de l'historique
        function paginateHistory() {
            $('body').on('click','#paginateCourseCardHistory a', function (e) {
                e.preventDefault();
                var $a = $(this);
                var url = $a.attr('href');

                $.ajax({
                    type: 'GET',
                    url: url,
                    success: function (data) {
                        $('#table-course-card-history').replaceWith(data);
                    }, error: function () {
                    }
                })
            });
        }

        $(document).ready(function(){
            // Initialisation des modals
            initMaterialize();
            loadModalAddCourseCard();
            loadModalUpdateHorse();
            addCourseCard();
            paginateHistory();
            addCourseCardHistory();
            updateHorse();
        });
    </script>
{% endblock %}

